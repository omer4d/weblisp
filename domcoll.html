
<!DOCTYPE html>
<html>
<head>

  <script type="text/javascript" src="jquery-2.1.4.js"></script>

  <style type="text/css">
    
  </style>

  <title>DOM collection by StasB</title>

  
    




<script type='text/javascript'>//<![CDATA[
window.onload=function(){
// **************************
// * Generic collection ops *
// **************************

function reduce(coll, rf, initial)
{
    return coll.reduce(rf, initial);
}

function map(coll, f)
{
    if("map" in coll)
        return coll.map(f);
    else
    {
        return {
            reduce: function(rf, initial) {
                return coll.reduce(function(accum, v) {
                    return rf.call(this, accum, f(v));
                }, initial);
            }
        };
    }
}

function filter(coll, pred)
{
    if("filter" in coll)
        return coll.filter(pred);
    else
    {
        return {
            reduce: function(rf, initial) {
                return coll.reduce(function(accum, v) {
                    return pred(v) ? rf.call(this, accum, v) : accum;
                }, initial);
            }
        };
    }
}

function first(coll)
{
    if("first" in coll)
        return coll.first();
    else
    {
        return coll.reduce(function(accum, v) {
            return this.reduced(v);
        }, undefined);
    }
}

function last(coll)
{
    if("last" in coll)
        return coll.last();
    else
    {
        return coll.reduce(function(accum, v) {
            return v;
        }, undefined);
    }
}

function count(coll)
{
    if("count" in coll)
        return coll.count();
    else
    {
        return coll.reduce(function(accum, v) {
            return accum + 1;
        }, 0);
    }
}

function take(coll, n)
{
    if("take" in coll)
        return coll.take(n);
    else
    {
        return {
            reduce: function(rf, initial) {
                var rem = n;
                
                return coll.reduce.call(this, function(accum, v) {
                    --rem;
                    if(rem >= 0)
                        return rf.call(this, accum, v);
                    else
                    	return this.reduced(accum);
                }, initial);
            }
        };
    }
}

function drop(coll, n)
{
    if("drop" in coll)
        return coll.drop(n);
    else
    {
        return {
            reduce: function(rf, initial) {
                var rem = n;
                
                return coll.reduce.call(this, function(accum, v) {
                    --rem;
                    if(rem >= 0)
                        return accum;
                    else
                        return rf.call(this, accum, v);
                }, initial);
            }
        };
    }
}

function interpose(coll, x)
{
    if("interpose" in coll)
        return coll.interpose(x);
    else
    {
        return {
            reduce: function(rf, initial) {
                var fst = true;
                
                return coll.reduce.call(this, function(accum, v) {
                    if(fst)
                    {
                        fst = false;
                        return rf.call(this, accum, v);
                    }
                    else
                        return rf.call(this, rf.call(this, accum, x), v);
                }, initial);
            }
        };
    }
}

function nth(coll, n)
{
    if("nth" in coll)
        return coll.nth(n);
    else
    {
        return coll.reduce(function(accum, v) {
            if(n === 0)
                return this.reduced(v);
            else
            {
                --n;
                return v;
            }
        }, undefined);
    }
}


// *****************
// * DOM traversal *
// *****************

function childIterStart(root, dir)
{
	return dir ? root.firstChild : root.lastChild;
}

function advanceChildIter(iter, dir)
{
	return dir ? iter.nextSibling : iter.previousSibling;
}

function reduceDOMHelper(root, dir, ctx, rf, accum)
{
	if(dir)
		accum = rf.call(ctx, accum, root);
    
    if(root.hasChildNodes())
    	for(var child = childIterStart(root, dir); child !== null && !ctx.stop;
        		child = advanceChildIter(child, dir))
        	accum = reduceDOMHelper(child, dir, ctx, rf, accum);
            
    if(!dir && !ctx.stop)
    	accum = rf.call(ctx, accum, root);
            
    return accum;
}

function reduceDOM(root, dir, rf, accum)
{
    var ctx = {
    	stop: false,
    	reduced: function(x) {
        	this.stop = true;
            return x;
        }
   	};
    
    return reduceDOMHelper(root, dir, ctx, rf, accum);
}

function reduceDOMFromBackwardHelper(node, root, ctx, rf, accum)
{
	accum = rf.call(ctx, accum, node);
   	
    if(node !== root)
    {
    	for(var t = advanceChildIter(node, false); t != null && !ctx.stop;
    			t = advanceChildIter(t, false))
        	accum = reduceDOMHelper(t, false, ctx, rf, accum);
        
    	if(!ctx.stop)
    		accum = reduceDOMFromBackwardHelper(node.parentNode, root, ctx, rf, accum);
    }
    
    return accum;
}

function reduceDOMFromForwardHelper(node, root, ctx, rf, accum)
{
	if(node !== root)
    {
		for(var t = advanceChildIter(node, true); t != null && !ctx.stop;
    			t = advanceChildIter(t, true))
       		accum = reduceDOMHelper(t, true, ctx, rf, accum);
        
    	if(!ctx.stop)
    		accum = reduceDOMFromForwardHelper(node.parentNode, root, ctx, rf, accum);
    }
    
    return accum;
}

function reduceDOMFrom(node, root, dir, rf, accum)
{
    var ctx = {
    	stop: false,
    	reduced: function(x) {
        	this.stop = true;
            return x;
        }
   	};
    
    if(dir)
    {
    	accum = reduceDOMHelper(node, true, ctx, rf, accum);
        return  ctx.stop ? accum : reduceDOMFromForwardHelper(node, root, ctx, rf, accum);
    }
    else
    	return reduceDOMFromBackwardHelper(node, root, ctx, rf, accum);
}

function domColl(root, dir)
{
    var obj = {};
    
    obj.reduce = function(rf, accum) {
    	return reduceDOM(root, dir, rf, accum);
    };
    
    return obj;
}

function domCollFrom(node, root, dir)
{
    var obj = {};
    
    obj.reduce = function(rf, accum) {
    	return reduceDOMFrom(node, root, dir, rf, accum);
    };
    
    return obj;
}

// *********
// * Tests *
// *********

function arrPush(arr, v)
{
	arr.push(v);
    return arr;
}

function reversed(arr)
{
	return arr.slice().reverse();
}

function runTests()
{
	var r = function(arr, v) {
    	if(v.nodeType === 3)
    		arr.push(v.textContent);
   	 	else
    		arr.push(v.tagName);
    	return arr;
	};

	var root = $("#root")[0];
	var nodes = reduceDOM(root, true, arrPush, []);
    
    var reducedTree = reduceDOM(root, true, r, []);
    
    console.log("Running tests...");
    
    if(reducedTree.join("") !== reduceDOM(root, false, r, []).reverse().join(""))
    {
    	console.log(reducedTree);
        console.log(reduceDOM(root, false, r, []).reverse());
    	throw "WTF1!";
    }
    
	for(var i = 0; i < nodes.length; ++i)
    {
    	var a = reduceDOMFrom(nodes[i], root, true, r, []);
        
        if(a.join("") !== reducedTree.slice(i).join(""))
        {
        	console.log(i);
        	console.log(a);
            console.log(reducedTree.slice(i));
            throw "WTF2!";
        }
        
        var b = reduceDOMFrom(nodes[i], root, false, r, []);
        
        if(reversed(b).join("") !== reducedTree.slice(0, i + 1).join(""))
        {
        	console.log(i);
        	console.log(reversed(b));
            console.log(reducedTree.slice(0, i + 1));
            throw "WTF3!";
        }
        
        if(b.slice(1).reverse().concat(a).join("") !== reducedTree.join(""))
        {
        	console.log(a);
        	console.log(b);
            console.log(reducedTree);
            throw "WTF4!";
        }
        
        //console.log(b.slice(1).reverse().concat(a).join(""));
    }
    
    console.log("Passed!");
}

runTests();

function testReducer(accum, v)
{
	if(v.nodeType === 3)
    {
    	var text = v.textContent.trim();
        if(text != "")
        	accum.push(text);
    }
   	else
    {
        accum.push("<" + v.tagName + ">");
    }
    
    return accum;
}

function isTextNode(node)
{
	return node.nodeType === 3;
}

function stringifyNode(node)
{
	if(node.nodeType === 3)
    	return node.textContent.trim();
   	else
       	return "<" + node.tagName + ">";
}

function nonemptyStr(str)
{
	return str !== "";
}

function xform(coll)
{
	return take(filter(map(filter(coll, isTextNode), stringifyNode), nonemptyStr), 3);
	//return take(filter(coll, isTextNode), 3);
    //return take(coll, 3);
}

$("#go").click(function() {
	var node = document.getSelection().anchorNode;
    var root = $("#root")[0];
    
    var coll1 = xform(domCollFrom(node, root, false));
    var coll2 = xform(domCollFrom(node, root, true));
    
    console.log(coll1.reduce(arrPush, []).toString());
    console.log(coll2.reduce(arrPush, []).toString());
    
    
    //console.log(node);
    //console.log(reduceDOM(root, dir, testReducer, []).toString());
    //console.log(reduceDOMFrom(node, root, dir, testReducer, []).toString());
    
    /*
    var accum = "";
    
    var counter = 100;
    
    traverseText(node, $("#root")[0], true, function(ch) {
    	accum += ch;
        return true;
	});
    
    console.log(accum);*/
    /*
    var counter = 5;
    traverseBackwards(node, $("#root")[0], function(node) {
		if(node.nodeType === 3)
        {
			console.log(node.textContent, "!");
            --counter;
         }
    	//else
    		//console.log(node.tagName);
         return counter > 0;
	});*/
});
}//]]> 

</script>

  
</head>

<body>
  <div id="root" contenteditable="true">
    line1<br/>
    line2<br/>
    <div>
        line3<br/>
        <div>
            line4<br/>
            line5<br/>
        </div>
        <div>
            line6<br/>
            line7<br/>
        </div>
        line8<br/>
    </div>
    line9<br/>
    <div>
        <div>
        </div>
    </div>
    <div>
        line10<br/>
        <div>
            line11<br/>
        </div>
    </div>
</div>

<button id="go">
 GO!
</button>
  
</body>

</html>

